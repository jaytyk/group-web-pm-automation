name: PM Assistant

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: read
  issues: write

jobs:
  auto-triage-and-checklist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: PM assistant (labels + checklist comment)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const issue = context.payload.issue;
            const body = issue.body || "";

            const MARKER = "<!-- pm-assistant:checklist -->";

            const labelColors = {
              "type:new-build": "2da44e",
              "type:change": "8250df",
              "urgency:normal": "0969da",
              "urgency:fast": "d4a72c",
              "urgency:urgent": "d1242f",
              "risk:pii": "d1242f",
              "risk:auth": "fb8f44",
              "triage": "ededed",
            };

            function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

            function getField(label) {
              const re = new RegExp(`###\\s+${escapeRegExp(label)}\\s*\\n\\n([\\s\\S]*?)(?=\\n\\n###\\s+|$)`, 'm');
              const m = body.match(re);
              return (m ? m[1].trim() : "");
            }

            const requestType = getField("ìš”ì²­ ìœ í˜•"); // "ì‹ ê·œ êµ¬ì¶•" or "ìš´ì˜ ë³€ê²½"
            const siteName = getField("ì‚¬ì´íŠ¸/ë²•ì¸ëª…(ë˜ëŠ” ë„ë©”ì¸)");
            const requester = getField("ìš”ì²­ìž(ë¶€ì„œ/ì´ë¦„)");
            const urgency = getField("ê¸´ê¸‰ë„");
            const pii = getField("ê°œì¸ì •ë³´(PII) ìˆ˜ì§‘/ì €ìž¥/ì²˜ë¦¬ ë³€ê²½ ì—¬ë¶€");
            const auth = getField("ë¡œê·¸ì¸/íšŒì›/ê¶Œí•œ ê¸°ëŠ¥ ì˜í–¥ ì—¬ë¶€");
            const summary = getField("ìš”ì²­ ìš”ì•½(í•œ ë¬¸ë‹¨)");

            function includesAny(text, arr){
              const t = (text || "").toLowerCase();
              return arr.some(x => t.includes(String(x).toLowerCase()));
            }

            function mapUrgency(u){
              if (includesAny(u, ["ê¸´ê¸‰"])) return "urgency:urgent";
              if (includesAny(u, ["ë¹ ë¦„"])) return "urgency:fast";
              return "urgency:normal";
            }

            const wanted = new Set();
            wanted.add("triage");

            if (includesAny(requestType, ["ì‹ ê·œ"])) wanted.add("type:new-build");
            else wanted.add("type:change");

            wanted.add(mapUrgency(urgency));

            if (includesAny(pii, ["ìžˆìŒ"])) wanted.add("risk:pii");
            if (includesAny(auth, ["ìžˆìŒ"])) wanted.add("risk:auth");

            async function ensureLabel(name){
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                const color = labelColors[name] || "ededed";
                try {
                  await github.rest.issues.createLabel({
                    owner, repo, name,
                    color,
                    description: "Auto-created by PM Assistant"
                  });
                } catch (e2) {
                  // ì´ë¯¸ ìƒì„±ë˜ì—ˆê±°ë‚˜ ê¶Œí•œ/ê²½ìŸ ìƒí™©ì´ë©´ ë¬´ì‹œ
                }
              }
            }

            // 1) ë¼ë²¨ ìƒì„± ë³´ìž¥
            for (const name of wanted) await ensureLabel(name);

            // 2) ë¼ë²¨ ë¶€ì°©(ì¤‘ë³µ ì œì™¸)
            const existingLabels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));
            const toAdd = [...wanted].filter(x => !existingLabels.includes(x));
            if (toAdd.length) {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: toAdd });
            }

            // 3) ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„ íƒ
            const isNew = wanted.has("type:new-build");
            const checklistPath = isNew ? "templates/checklist-new-build.md" : "templates/checklist-change.md";
            const checklist = fs.readFileSync(checklistPath, "utf8");

            const piiNote = wanted.has("risk:pii")
              ? "\n> âš ï¸ **PII ì˜í–¥ ê°€ëŠ¥ì„±**: ìˆ˜ì§‘í•­ëª©/ë³´ê´€ê¸°ê°„/ì²˜ë¦¬ìœ„íƒ/íŒŒê¸°/ë™ì˜ë¬¸êµ¬/ì•½ê´€Â·ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë°˜ì˜ì„ ìš°ì„  ì ê²€í•˜ì„¸ìš”.\n"
              : "";

            const comment =
`${MARKER}
ðŸ‘‹ **PM ìžë™ ì•ˆë‚´(ë¼ë²¨ + ì²´í¬ë¦¬ìŠ¤íŠ¸)**ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.

### ìš”ì•½
- **ìš”ì²­ ìœ í˜•**: ${requestType || "N/A"}
- **ëŒ€ìƒ**: ${siteName || "N/A"}
- **ìš”ì²­ìž**: ${requester || "N/A"}
- **ê¸´ê¸‰ë„**: ${urgency || "N/A"}
- **PII**: ${pii || "N/A"}
- **ë¡œê·¸ì¸/ê¶Œí•œ ì˜í–¥**: ${auth || "N/A"}

${summary ? `> ${summary}\n` : ""}

${piiNote}

${checklist}

---
#### ìš´ì˜ íŒ
- ì´ ì´ìŠˆë¥¼ â€œìž‘ì—… í—ˆë¸Œâ€ë¡œ ì‚¬ìš©(ê²°ì •ì‚¬í•­/ë¦¬ìŠ¤í¬/ìŠ¹ì¸ ë¡œê·¸ ì¶•ì )
- ì²´í¬ë¦¬ìŠ¤íŠ¸ ì™„ë£Œ í›„ Close
`;

            // 4) ê¸°ì¡´ ëŒ“ê¸€ ìžˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒì„±
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number, per_page: 100
            });
            const existing = comments.find(c => (c.body || "").includes(MARKER));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body: comment });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body: comment });
            }
